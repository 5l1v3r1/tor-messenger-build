#!/bin/sh
set -e

[% IF c("var/osx");
     INCLUDE build.osx;
     STOP;
   END -%]

mkdir bundle
[% IF c("var/windows") -%]
7z x -y -obundle [% c('input_files_by_name/instantbird') %]
mv bundle/instantbird bundle/Messenger
[% ELSE -%]
mkdir bundle/Messenger
tar xf [% c('input_files_by_name/instantbird') %] -C bundle/Messenger --strip 1
[% END -%]

mkdir bundle/Messenger/TorMessenger
tar xf [% c('input_files_by_name/bundle-data') %] -C bundle/Messenger/TorMessenger

[% IF c("var/linux") %]
tar xf [% c('input_files_by_name/gcc') %]
chmod 755 start-unnamed-messenger start-unnamed-messenger.desktop execdesktop

cp start-unnamed-messenger.desktop bundle/
mv start-unnamed-messenger.desktop bundle/Messenger/
mv start-unnamed-messenger bundle/Messenger/
mv execdesktop bundle/Messenger/

mkdir -p bundle/Messenger/lib
cp -L gcc/lib[% c('arch') == 'x86_64' ? '64' : '32' %]/libstdc++.so.6 bundle/Messenger/lib/
[% END %]

cp cert_override.txt bundle/Messenger/TorMessenger/Data/Browser/profile.default/

cd bundle/Messenger/extensions
tar xf ../../../[% c('input_files_by_name/ctypes-otr') %]
mv ctypes-otr* 'ctypes-otr@tormessenger'
mkdir tor-launcher@torproject.org
7z x -y -otor-launcher@torproject.org ../../../[% c('input_files_by_name/tor-launcher') %]
mkdir -p tor-launcher@torproject.org/TorBrowser/Data
[% IF c("var/windows") -%]
7z x ../../../[% c('input_files_by_name/tor-browser') %]
mv \$_OUTDIR tor-browser_en-US
cp -pf tor-browser_en-US/Browser/libssp-0.dll tor-browser_en-US/Browser/TorBrowser/Tor/
[% ELSE -%]
tar xf ../../../[% c('input_files_by_name/tor-browser') %]
[% END -%]
sed -i 's/^SocksPort .*/SocksPort [% c("var/tor_socks_port") %]/' tor-browser_en-US/Browser/TorBrowser/Data/Tor/torrc-defaults
sed -i 's/^ControlPort .*/ControlPort [% c("var/tor_control_port") %]/' tor-browser_en-US/Browser/TorBrowser/Data/Tor/torrc-defaults
mv tor-browser_en-US/Browser/TorBrowser/Tor tor-launcher@torproject.org/TorBrowser/Tor
mv tor-browser_en-US/Browser/TorBrowser/Data/Tor tor-launcher@torproject.org/TorBrowser/Data/Tor
rm -Rf tor-browser_en-US
cd ../../../
mv bundle unnamed-messenger
[% IF c('var/windows') -%]
makensis unnamed-messenger.nsi
mv unnamed-messenger-install.exe [% dest_dir _ '/' _ c('filename') %]
[% ELSE -%]
[% c('tar', {
        tar_src => [ 'unnamed-messenger' ],
        tar_args => '-cJf ' _ dest_dir _ '/' _ c('filename'),
        }) %]
[% END -%]
